---

- hosts: servers
  gather_facts: true
  pre_tasks:
    - name: COMMAND | Install openssl
      command: openssl req -new -newkey rsa:4096 -days 3650 -nodes -x509 -subj "/CN={{ ansible_fqdn }}" -keyout {{ teleport_config_proxy_service_key_pairs.0.key_file }} -out {{ teleport_config_proxy_service_key_pairs.0.cert_file }}
      args:
        creates: "{{ teleport_config_proxy_service_key_pairs.0.key_file }}"

- hosts: all
  gather_facts: true
  pre_tasks:
    - name: APT | Install debug packets
      apt:
        name: '{{ item }}'
        update_cache: yes
        cache_valid_time: 3600
      loop: ['curl', 'htop', 'strace', 'vim']
  roles:
    - ../../

- hosts: servers
  gather_facts: false
  vars:
    __tls_files: ['/root/server.key', '/root/server.crt', '/root/server.cas']
  tasks:
    - name: COMMAND | Create TLS keys from servers
      command: tctl auth sign --format=db --host=teleport-node-debian-bullseye --out=server --ttl=2190h
      args:
        chdir: /root
        creates: '{{ __tls_files.0 }}'

    - name: FETCH | Get TLS files
      fetch:
        src: "{{ item }}"
        dest: "{{ playbook_dir }}/tmp/"
        flat: true
      loop: "{{ __tls_files }}"

- hosts: nodes
  tasks:
    - name: APT | Install extra packages (application / database tests)
      apt:
        name: '{{ item }}'
        update_cache: yes
        cache_valid_time: 3600
      loop: ['netdata', 'mariadb-server', 'mariadb-client']

    - name: COPY | Deploy teleport TLS config in the node
      copy:
        src: "{{ item }}"
        dest: "/root/"
      with_fileglob: "{{ playbook_dir }}/tmp/server.*"

    - name: LINEINFILE | Deploy MariaDB custom config
      lineinfile:
        path: /etc/mysql/mariadb.conf.d/99-teleport-tls.cnf
        line: "{{ item }}"
        create: true
      loop:
        - '[mysqld]'
        - 'require_secure_transport=ON'
        - 'ssl-ca=/root/server.cas'
        - 'ssl-cert=/root/server.crt'
        - 'ssl-key=/root/server.key'
